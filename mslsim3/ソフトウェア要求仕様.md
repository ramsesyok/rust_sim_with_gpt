# シミュレーション・ソフトウェア要求仕様書

## 1. 概要

1. **目的**  
   - Rustによる数値シミュレーションプログラムのサンプルとして、「中距離弾道ミサイル」「レーダ」「迎撃ミサイル」の3種類のオブジェクトを時系列で演算し、その結果を取得する。  
   - 複雑な物理再現は不要だが、十分な量の数値演算を含む。

2. **システム構成**  
   - シミュレーション空間: XYZ右手座標系 (Z軸が鉛直上向き, X軸が東向き, Y軸が北向き)。  
   - 時間ステップ: 変数 $\displaystyle dt$ [s] を用いる（デフォルト 0.1 s）。  
   - 演算モデル:  
     1. 中距離弾道ミサイル  
     2. 中距離弾道ミサイル探知用レーダ  
     3. 迎撃ミサイル  
   - シナリオに応じて、各モデルが複数インスタンス（オブジェクト）として登場する。

3. **前提条件**  
   - いずれのミサイルもロール角 $\displaystyle phi$ は変数として用意するが、常に 0 として扱う。  
   - 必要に応じてローパスフィルタを用い、数値振動を抑制する。  
   - 数値積分にはAdams-Bashforth 2段法を用いる。

---

## 2. 演算の基本要件

### 2.1 時間管理

1. シミュレーションは、$\displaystyle t = 0$ から開始し、オブジェクトごとの終了条件を満たすまで行う。  
2. タイムステップ $\displaystyle dt$ はデフォルト 0.1 s。必要に応じて変更可能とする。

### 2.2 空間座標系

1. 右手系 (X軸東, Y軸北, Z軸上向き)  
2. 位置ベクトル $\displaystyle \vec{r}(t) = (x(t),\, y(t),\, z(t))^T$  
3. 速度ベクトル $\displaystyle \vec{v}(t)$、加速度ベクトル $\displaystyle \vec{a}(t)$

### 2.3 ローパスフィルタ

- 振動抑制のため、1次遅れローパスフィルタなどを適宜適用:  
  $
    y_{\text{filtered}}(t)
      = \alpha\,y(t) + (1 - \alpha)\,y_{\text{filtered}}(t - dt),
    \quad 0 < \alpha < 1.
  $

### 2.4 汎用演算

1. **数値積分 (Adams-Bashforth 2段法)**  
   常微分方程式
   $
     \frac{dy}{dx} = f(x,\, y),
     \quad y(a) = y_0
   $

   を離散化ステップ $\displaystyle \Delta x$ で解く場合、Adams-Bashforth 2段法:
   
   $
     y_{n+1}
       = y_n
         + \frac{\Delta x}{2} \Bigl[
             3\,f(x_n,\,y_n) - f(x_{n-1},\,y_{n-1})
           \Bigr].
   $
   
   シミュレーションでは $\displaystyle x \equiv t$ (時間) として用いる。

2. **$\displaystyle \mathrm{atan2}(y,\, x)$ のゼロ入力チェック**  
   - $\displaystyle |x| < \epsilon$ かつ $\displaystyle |y| < \epsilon$ （$\displaystyle \epsilon$ は十分小さい閾値）であれば、エラーや警告を発する。  
   - 単純比較 == 0 ではなく、許容誤差による判定を行う。

---

## 3. オブジェクト別要求仕様

### 3.1 中距離弾道ミサイル

1. **運用期間・終了条件**  
   - 発射 ($\displaystyle t=0$) から地表($\displaystyle z=0$) に到達、または迎撃ミサイルによって迎撃されるまで。  
   - いずれの条件を満たした時点で終了。

2. **大気密度の考慮**  
   - 大気密度 $\displaystyle \rho(z)$ を用いて空気抵抗を計算。例:  
     
     $
       \rho(z) = \rho_0\,\exp\Bigl(-\frac{z}{H}\Bigr).
     $

     （$\displaystyle \rho_0,\,H$ は定数）

3. **燃料減少による重量変化**  
   - 質量 $\displaystyle m(t)$ が時間とともに変化:  
     $
       \frac{dm}{dt} = -\,\alpha \, T(t)
     $

     （$\displaystyle \alpha$ は燃料消費率係数など）

4. **運動方程式**  
   - 力の内訳: 推力 $\displaystyle \vec{T}(t)$、空気抵抗 $\displaystyle \vec{D}(t)$、重力 $\displaystyle \vec{W}(t)$。  
     $
       m(t)\,\vec{a}(t)
         = \vec{T}(t) + \vec{D}(t) + \vec{W}(t).
     $
   - 推力ベクトル:  
     $
       \vec{T}(t) = T(t)\,
         \begin{bmatrix}
           \cos\theta\,\cos\psi \\
           \cos\theta\,\sin\psi \\
           \sin\theta
         \end{bmatrix}.
     $

     （ロール角 $\displaystyle \phi = 0$）

   - 抗力:  
     $
       \vec{D}(t)
         = - \frac{1}{2}\,\rho(z)\,C_D\,S\,\|\vec{v}(t)\|^2
           \,\frac{\vec{v}(t)}{\|\vec{v}(t)\|}.
     $

   - 重力:  
     $
       \vec{W}(t)
         = -\,m(t)\,g\,
         \begin{bmatrix}
           0 \\ 0 \\ 1
         \end{bmatrix}.
     $
   - 速度・位置はAdams-Bashforth 2段法で更新。  
   - 姿勢角（$\displaystyle \theta,\psi$）も同様に更新。

---

### 3.2 中距離弾道ミサイルの探知用レーダ

#### 3.2.1 レーダ諸元

1. **探知範囲**  
   - 方位角カバー範囲 $\displaystyle \Delta \psi_{\text{radar}}$ 
   - 仰角カバー範囲 $\displaystyle \Delta \theta_{\text{radar}}$ 
   - 探知距離 $\displaystyle R_{\max}$

2. **探知周期**  
   - 0.1 s（固定）

#### 3.2.2 探知アルゴリズム （**角度判定を含む**）

1. レーダ位置: $\displaystyle \vec{r}_{\text{radar}}$ 
2. ミサイル位置: $\displaystyle \vec{r}_{\text{missile}}(t)$ 
3. **距離判定**  
   $
     d(t)
       = \bigl\|\vec{r}_{\text{missile}}(t)
               - \vec{r}_{\text{radar}}\bigr\|.
   $

   これが $\displaystyle R_{\max}$ 以下なら、まず距離的に探知可能。
4. **角度判定**  
   - まず、レーダ基準ベクトル（例: レーダが正面を向く方向）$\displaystyle \vec{d}_{\text{radar}}$ を設定。  
   - ミサイル方向ベクトル  
     $
       \vec{d}_{\text{target}}(t)
         = \vec{r}_{\text{missile}}(t)
           - \vec{r}_{\text{radar}}.
     $

   - 水平面( XY平面 )での方位角差 $\displaystyle \Delta \psi$ を、$\displaystyle \mathrm{atan2}$等で算出し、$\displaystyle |\Delta \psi| \leq \Delta \psi_{\text{radar}}/2$ か判定。  
   - 鉛直方向( Z成分 )を含めた仰角差 $\displaystyle \Delta \theta$ を、同様の三角演算で算出し、$\displaystyle |\Delta \theta| \leq \Delta \theta_{\text{radar}}/2$ か判定。
   - 角度判定にも$\displaystyle \mathrm{atan2}$のゼロ近傍チェックを組み込むこと。
5. **最終判定**  
   - 距離判定かつ角度判定において範囲内であれば「探知成功」。  
   - 探知成功時、迎撃ミサイルオブジェクトに「発射指示」を出すとともに、探知周期 0.1 s ごとにミサイル位置を送信。

---

### 3.3 迎撃ミサイル

1. **演算期間・終了条件**  
   - レーダからの発射指示によりスタート。  
   - 中距離弾道ミサイルの迎撃成功、またはミサイルが $\displaystyle z=0$ に到達して迎撃不能になるまで。
2. **誘導方式 (比例航法など)**  
   - レーダから受信した弾道ミサイルの位置 $\displaystyle \vec{r}_{\text{missile}}$ を用い、相対位置・相対速度を計算して誘導指令を出す。  
   - 例:  
     $
       \vec{a}_{\text{guidance}}
         = N\,\|\vec{v}_{\text{rel}}\|\,
           \dot{\lambda}\,\hat{n}_{\text{LOS}},
     $

     ($\displaystyle N$は航法定数、$\displaystyle \lambda$はLOS角、$\displaystyle \hat{n}_{\text{LOS}}$はLOSに垂直な方向単位ベクトル)
3. **運動演算**  
   - 中距離弾道ミサイルと同様のステップで、推力・加速度・速度・位置・姿勢を更新。  
   - 燃料消費や空気抵抗モデルも同等または個別設定を可とする。

---

## 4. 実行フロー (概略)

1. **初期化**  
   - オブジェクト数や初期状態、$\displaystyle dt$等の設定。  
2. **タイムループ**  
   - 各オブジェクトの運動演算（推力 → 加速度 → 速度 → 位置 → 姿勢）  
   - レーダ演算（距離と角度判定、迎撃ミサイルへの指示）  
   - 迎撃ミサイル誘導  
   - 各オブジェクトの終了条件をチェック  
3. **終了**  
   - すべてのオブジェクトが終了条件に達したらシミュレーション終了。

---

## 5. エラー処理・数値安定性

1. **$\mathrm{atan2}$ ゼロ近傍判定**  
   - $\displaystyle |x| < \epsilon$ かつ $\displaystyle |y| < \epsilon$ であればエラーや警告を出す。  
2. **無限大・NaN**  
   - $\displaystyle dt$ の設定やローパスフィルタで数値発散を抑制。  
3. **負の質量**  
   - 燃料消費による質量計算で$\displaystyle m(t)\ge0$を担保し、負値になったらエラー。

---

## 6. 実装上の留意事項 (Rust向け)

1. **数値型**  
   - デフォルト $\displaystyle f64$。状況により `f32` や `Decimal` も検討。  
2. **モジュール分割**  
   - 「汎用数値演算」「弾道ミサイル」「レーダ」「迎撃ミサイル」をモジュール化。  
3. **並列化**  
   - 所有権モデルを考慮しつつ、並列に実装可能な箇所を検討。  
4. **ユニットテスト / プロパティテスト**  
   - 各計算ロジック（Adams-Bashforth、atan2安全版 など）を細かくテスト。

---

## 7. パフォーマンス要件

1. **シミュレーション時間**  
   - 数分～数十分での完了が望ましい。  
2. **拡張性**  
   - 複数のミサイルや迎撃ミサイルを追加しても同一ルーチンで対応可能。

---

## 8. モデル別パラメータ一覧

実装時に必要な主要パラメータをモデルごとにリストアップします。  
それぞれシミュレーション開始時点で設定する初期値、および時系列で更新が必要なものを明確にしておきます。

### 8.1 中距離弾道ミサイル

| パラメータ名         | 記号 / 型     | 役割・補足                             | 更新の有無        |
|----------------------|--------------|-----------------------------------------|-------------------|
| 質量                 | $\displaystyle m(t)$ / f64  | 推力・燃料消費の影響を受ける             | **動的更新**      |
| 燃料消費率係数       | $\displaystyle \alpha$ / f64 | 推力との積により質量減少速度を決定       | **固定**          |
| 推力                 | $\displaystyle T(t)$ / f64   | 時間・フェーズによって変化可能           | **動的更新** (シナリオや制御) |
| 空気抵抗係数         | $\displaystyle C_D$ / f64    | 抗力計算に使用                           | **固定**          |
| 断面積               | $\displaystyle S$ / f64      | 抗力計算に使用                           | **固定**          |
| 大気密度モデル定数   | $\displaystyle \rho_0,\,H$ / f64 | $\displaystyle \rho(z)$ の計算に使用 | **固定**          |
| 重力加速度           | $\displaystyle g$ / f64      | 基本定数                                 | **固定**          |
| 姿勢角（ピッチ）     | $\displaystyle \theta(t)$ / f64  | 推力ベクトルの方向                       | **動的更新** (制御など) |
| 姿勢角（ヨー）       | $\displaystyle \psi(t)$ / f64     | 推力ベクトルの方向                       | **動的更新** (制御など) |
| 姿勢角（ロール）     | $\displaystyle \phi(t)=0$ / f64   | 常に 0 扱い                              | **固定**          |
| 位置ベクトル         | $\displaystyle \vec{r}(t)$ / (f64,f64,f64) | XYZ空間上の座標                 | **動的更新**      |
| 速度ベクトル         | $\displaystyle \vec{v}(t)$ / (f64,f64,f64) | 速度                           | **動的更新**      |
| 加速度ベクトル       | $\displaystyle \vec{a}(t)$ / (f64,f64,f64) | 運動方程式で計算される           | **動的更新**      |
| 地表衝突フラグ       | bool          | $\displaystyle z(t)\leq 0$ でtrueに     | **動的更新**      |

### 8.2 中距離弾道ミサイルの探知用レーダ

| パラメータ名        | 型       | 役割・補足                                               | 更新の有無     |
|---------------------|---------|-----------------------------------------------------------|----------------|
| レーダ位置          | $\displaystyle \vec{r}_{\text{radar}}$ / (f64,f64,f64) | 固定配置 or 移動レーダに対応                             | **固定** or 動的(移動レーダの場合) |
| レーダ基準ベクトル  | $\displaystyle \vec{d}_{\text{radar}}$ / (f64,f64,f64) | レーダが指向している「正面」方向                          | **固定** or 動的(旋回型レーダの場合) |
| 探知距離            | $\displaystyle R_{\max}$ / f64                           | 距離判定用                                             | **固定**      |
| 方位角カバー範囲    | $\displaystyle \Delta \psi_{\text{radar}}$ / f64         | $\displaystyle \pm\frac{\Delta \psi_{\text{radar}}}{2}$で判定 | **固定**      |
| 仰角カバー範囲      | $\displaystyle \Delta \theta_{\text{radar}}$ / f64       | $\displaystyle \pm\frac{\Delta \theta_{\text{radar}}}{2}$で判定 | **固定**      |
| 探知周期            | f64      | デフォルト 0.1 s (固定)                                 | **固定**      |
| 探知状態フラグ      | bool     | 前回探知に成功しているか等のフラグ                       | **動的更新**   |
| 発射指示フラグ      | bool     | ミサイルが探知範囲内ならtrue                            | **動的更新**   |

### 8.3 迎撃ミサイル

| パラメータ名         | 記号 / 型       | 役割・補足                                                        | 更新の有無         |
|----------------------|----------------|--------------------------------------------------------------------|--------------------|
| 質量                 | $\displaystyle m_{\text{int}}(t)$ / f64       | 燃料消費を考慮する場合は動的                                       | **動的更新**       |
| 燃料消費率係数       | $\displaystyle \alpha_{\text{int}}$ / f64     | 中距離弾道ミサイルと同等か、別値を設定可                           | **固定**           |
| 推力                 | $\displaystyle T_{\text{int}}(t)$ / f64       | 時間変化可能                                                      | **動的更新**       |
| 空気抵抗係数         | $\displaystyle C_{D,\text{int}}$ / f64        | 抗力計算に使用                                                    | **固定**           |
| 断面積               | $\displaystyle S_{\text{int}}$ / f64          | 抗力計算に使用                                                    | **固定**           |
| 重力加速度           | $\displaystyle g$ / f64                        | 基本定数                                                          | **固定**           |
| 姿勢角（ピッチ）     | $\displaystyle \theta_{\text{int}}(t)$ / f64  | 推力ベクトル方向                                                  | **動的更新** (誘導制御) |
| 姿勢角（ヨー）       | $\displaystyle \psi_{\text{int}}(t)$ / f64     | 推力ベクトル方向                                                  | **動的更新** (誘導制御) |
| 姿勢角（ロール）     | $\displaystyle \phi_{\text{int}}(t)=0$ / f64   | 常に 0 扱い                                                       | **固定**           |
| 位置ベクトル         | $\displaystyle \vec{r}_{\text{int}}(t)$ / (f64,f64,f64) | XYZ空間上の座標                                      | **動的更新**       |
| 速度ベクトル         | $\displaystyle \vec{v}_{\text{int}}(t)$ / (f64,f64,f64) | 速度                                                  | **動的更新**       |
| 加速度ベクトル       | $\displaystyle \vec{a}_{\text{int}}(t)$ / (f64,f64,f64) | 運動方程式で計算される                                 | **動的更新**       |
| 発射開始フラグ       | bool             | レーダからの指示を受け取ったかどうか                               | **動的更新**       |
| 迎撃完了フラグ       | bool             | 弾道ミサイル迎撃判定によりtrue                                    | **動的更新**       |
| 比例航法関連定数     | $\displaystyle N$ / f64, ほか                  | LOS角速度等に基づく指令計算に使用                                  | **固定**または動的更新 |

---

## 9. まとめ

- 本改訂版では、**レーダ判定における「角度判定」**を明記し、**演算に必要なパラメータ**を各モデルごとにリストアップした。  
- シミュレーション実行時には、これらパラメータを初期化し、**「推力 → 加速度 → 速度 → 位置 → 姿勢」** の更新ステップをタイムループで繰り返す。  
- レーダは 0.1 s 周期で、**「距離判定・角度判定」** を行い、探知成功時に迎撃ミサイルを発射指示、座標更新を通知する。  
- 迎撃ミサイルは比例航法などの誘導ロジックにより、中距離弾道ミサイルを追尾・迎撃する。  
- いずれも**数値安定性を確保**しつつ、**Adams-Bashforth 2段法**で数値積分を行い、ロール角 $\displaystyle \phi=0$ など簡易化したモデルを用いる。

以上により、中距離弾道ミサイルとレーダ、迎撃ミサイルの三者で構成されるシミュレーションがRustにて実装可能となる。各パラメータと演算式を明確化することで、実装ミスの最小化やテストの効率化が期待される。